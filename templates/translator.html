{% extends 'base.html' %}
{% block title %}SignBridge — Live Translator{% endblock %}

{% block extra_css %}
<style>
  /* ── Layout ────────────────────────────────────── */
  .translator-wrap {
    padding: 1.5rem 0 3rem;
  }
  .page-label {
    font-size: .72rem;
    font-weight: 700;
    letter-spacing: .1em;
    text-transform: uppercase;
    color: var(--brand);
    margin-bottom: .2rem;
  }
  .page-title {
    font-size: 1.35rem;
    font-weight: 800;
    color: var(--text);
    letter-spacing: -0.02em;
    margin-bottom: 0;
  }

  /* ── Camera card ───────────────────────────────── */
  .camera-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    padding: 1.25rem;
  }
  .card-section-title {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: .875rem;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: .45rem;
  }
  .card-section-title i { color: var(--brand); font-size: 1rem; }

  /* Status indicator */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    font-size: .78rem;
    font-weight: 500;
    color: var(--text-muted);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: .25rem .75rem;
  }
  #statusDot {
    width: 8px; height: 8px; border-radius: 50%;
    background: #cbd5e1;
    transition: background .3s;
    flex-shrink: 0;
  }
  #statusDot.active   { background: #22c55e; animation: dot-pulse 1.6s ease-in-out infinite; }
  #statusDot.processing { background: #f59e0b; }
  @keyframes dot-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,.5); }
    50%       { box-shadow: 0 0 0 5px rgba(34,197,94,0); }
  }

  /* Language select */
  .lang-select-wrap { max-width: 240px; }
  .lang-select-wrap .form-select {
    font-size: .85rem;
    border-color: var(--border);
    border-radius: 8px;
    color: var(--text);
  }
  .lang-select-wrap .form-select:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(37,99,235,.1);
  }

  /* Video container */
  #videoContainer {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background: #0f172a;
    aspect-ratio: 16/9;
  }
  #video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
    display: block;
  }
  #canvas { display: none; }

  .video-overlay-top {
    position: absolute;
    top: 10px; left: 10px; right: 10px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    pointer-events: none;
  }
  .session-chip {
    background: rgba(0,0,0,.55);
    color: rgba(255,255,255,.9);
    font-size: .72rem;
    font-weight: 600;
    padding: .25rem .7rem;
    border-radius: 20px;
    backdrop-filter: blur(4px);
    letter-spacing: .03em;
  }
  .live-chip {
    background: rgba(220,38,38,.85);
    color: #fff;
    font-size: .7rem;
    font-weight: 700;
    padding: .22rem .65rem;
    border-radius: 20px;
    letter-spacing: .06em;
    text-transform: uppercase;
    display: none;
    align-items: center;
    gap: .35rem;
  }
  .live-chip .live-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #fff;
    animation: dot-pulse 1.2s infinite;
  }
  .live-chip.show { display: flex; }

  /* Camera idle state */
  .camera-idle {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: .75rem;
    color: rgba(255,255,255,.45);
  }
  .camera-idle i { font-size: 2.75rem; }
  .camera-idle p { font-size: .82rem; letter-spacing: .04em; text-transform: uppercase; margin: 0; }

  /* Controls strip */
  .controls-strip {
    display: flex;
    align-items: center;
    gap: .6rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  .controls-strip .btn {
    font-size: .875rem;
    font-weight: 600;
    border-radius: 9px;
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .5rem 1.1rem;
  }
  .auto-toggle-wrap {
    display: flex;
    align-items: center;
    gap: .45rem;
    font-size: .82rem;
    color: var(--text-muted);
    margin-left: auto;
  }
  .auto-toggle-wrap .form-check-input {
    cursor: pointer;
    border-color: var(--border);
  }
  .auto-toggle-wrap .form-check-input:checked { background-color: var(--brand); border-color: var(--brand); }

  /* ── Result card ───────────────────────────────── */
  .result-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    padding: 1.25rem;
    margin-bottom: .75rem;
  }

  .detection-display {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.25rem;
    text-align: center;
    margin: .75rem 0;
  }
  .sign-badge {
    display: inline-block;
    background: var(--brand-subtle);
    color: var(--brand);
    border: 1px solid rgba(37,99,235,.2);
    border-radius: 10px;
    padding: .45rem 1.25rem;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 1.25rem;
    font-weight: 800;
    margin-bottom: .6rem;
    letter-spacing: -0.01em;
  }
  .translation-main {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: .25rem;
  }
  .translation-desc {
    font-size: .8rem;
    color: var(--text-muted);
  }

  /* Confidence bar */
  .confidence-wrap { margin-top: .75rem; }
  .confidence-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: .35rem;
    font-size: .78rem;
    color: var(--text-muted);
  }
  .confidence-header span:last-child { font-weight: 700; color: var(--text); }
  .confidence-track {
    height: 5px;
    background: var(--bg);
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  #confidence-bar {
    height: 100%;
    border-radius: 10px;
    width: 0%;
    transition: width .45s ease, background-color .3s;
    background: #22c55e;
  }

  /* Action buttons */
  .action-btns {
    display: flex;
    gap: .5rem;
    margin-top: .85rem;
  }
  .action-btns .btn {
    font-size: .825rem;
    font-weight: 600;
    border-radius: 9px;
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .5rem 1rem;
  }

  /* Feedback panel */
  .feedback-panel {
    margin-top: .85rem;
    padding-top: .85rem;
    border-top: 1px solid var(--border);
  }
  .feedback-label {
    font-size: .78rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: .4rem;
  }
  .star-rating { display: flex; gap: .2rem; margin-bottom: .6rem; }
  .star-rating button {
    background: none;
    border: none;
    font-size: 1.35rem;
    cursor: pointer;
    color: #d1d5db;
    transition: color .15s, transform .15s;
    padding: 0 .1rem;
    line-height: 1;
  }
  .star-rating button:hover { transform: scale(1.15); }

  /* ── Session Log ───────────────────────────────── */
  .log-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    overflow: hidden;
  }
  .log-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: .85rem 1.1rem;
    border-bottom: 1px solid var(--border);
  }
  .log-header .card-section-title { font-size: .875rem; }
  .log-scroll {
    max-height: 310px;
    overflow-y: auto;
    padding: .6rem .75rem;
  }
  .log-scroll::-webkit-scrollbar { width: 4px; }
  .log-scroll::-webkit-scrollbar-track { background: transparent; }
  .log-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .history-item {
    display: flex;
    align-items: center;
    gap: .6rem;
    padding: .55rem .65rem;
    border-radius: 8px;
    font-size: .84rem;
    border-left: 3px solid var(--brand);
    background: var(--bg);
    margin-bottom: .4rem;
    animation: slideIn .25s ease;
  }
  .history-item .hi-sign {
    font-weight: 700;
    color: var(--text);
    white-space: nowrap;
  }
  .history-item .hi-arrow { color: var(--text-muted); font-size: .75rem; flex-shrink: 0; }
  .history-item .hi-text { color: var(--text-muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .history-item .hi-conf {
    font-size: .72rem;
    font-weight: 600;
    color: var(--brand);
    background: var(--brand-subtle);
    padding: .1rem .45rem;
    border-radius: 20px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .log-empty {
    text-align: center;
    color: var(--text-muted);
    font-size: .85rem;
    padding: 2rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: .5rem;
  }
  .log-empty i { font-size: 1.75rem; opacity: .35; }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid translator-wrap" style="max-width:1160px">

  <!-- Page heading (mobile: compact) -->
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <p class="page-label mb-0">Live Session</p>
      <h1 class="page-title">Sign Language Translator</h1>
    </div>
    <span class="status-badge">
      <span id="statusDot"></span>
      <span id="statusText">Camera off</span>
    </span>
  </div>

  <div class="row g-3">

    <!-- ══ LEFT: Camera ══════════════════════════════════════ -->
    <div class="col-lg-7">
      <div class="camera-card">

        <!-- Card header -->
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="card-section-title">
            <i class="bi bi-camera-video-fill"></i>Live Camera
          </span>
          <!-- Language selector -->
          <div class="lang-select-wrap">
            <select id="langSelect" class="form-select form-select-sm">
              {% for lang in sign_languages %}
              <option value="{{ lang.code }}">{{ lang.name }} ({{ lang.code }})</option>
              {% empty %}
              <option value="ASL">American SL (ASL)</option>
              <option value="BSL">British SL (BSL)</option>
              <option value="KSL">Kenyan SL (KSL)</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Video container -->
        <div id="videoContainer">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="canvas"></canvas>

          <!-- Overlays -->
          <div class="video-overlay-top">
            <span class="session-chip"><i class="bi bi-record2 me-1"></i>Session #{{ session.pk }}</span>
            <span class="live-chip" id="liveChip"><span class="live-dot"></span>LIVE</span>
          </div>

          <!-- Idle placeholder -->
          <div class="camera-idle" id="cameraIdle">
            <i class="bi bi-camera-video-off"></i>
            <p>Camera inactive</p>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls-strip">
          <button id="btnStart" class="btn btn-brand" onclick="startCamera()">
            <i class="bi bi-play-fill"></i>Start Camera
          </button>
          <button id="btnStop" class="btn btn-outline-danger d-none" onclick="stopCamera()">
            <i class="bi bi-stop-fill"></i>Stop
          </button>
          <button id="btnCapture" class="btn btn-outline-primary d-none" onclick="captureAndAnalyze()">
            <i class="bi bi-search"></i>Analyze Now
          </button>

          <label class="auto-toggle-wrap mb-0">
            <input class="form-check-input mt-0" type="checkbox" id="autoMode" checked>
            <span>Auto every 3s</span>
          </label>
        </div>
      </div>
    </div>

    <!-- ══ RIGHT: Results + Log ══════════════════════════════ -->
    <div class="col-lg-5 d-flex flex-column gap-3">

      <!-- Current Detection -->
      <div class="result-card">
        <span class="card-section-title">
          <i class="bi bi-magic"></i>Current Detection
        </span>

        <div class="detection-display">
          <div class="sign-badge" id="signName">—</div>
          <p class="translation-main" id="translationText">Waiting for sign…</p>
          <p class="translation-desc" id="descriptionText"></p>
        </div>

        <!-- Confidence -->
        <div class="confidence-wrap">
          <div class="confidence-header">
            <span>AI Confidence</span>
            <span id="confidenceValue">—</span>
          </div>
          <div class="confidence-track">
            <div id="confidence-bar"></div>
          </div>
        </div>

        <!-- Actions -->
        <div class="action-btns">
          <button id="btnSpeak" class="btn btn-brand flex-grow-1" onclick="speakTranslation()" disabled>
            <i class="bi bi-volume-up-fill"></i>Speak
          </button>
          <button id="btnFeedback" class="btn btn-outline-secondary" onclick="toggleFeedback()" disabled>
            <i class="bi bi-star"></i>Rate
          </button>
        </div>

        <!-- Feedback panel -->
        <div id="feedbackPanel" class="feedback-panel d-none">
          <p class="feedback-label">How accurate was the translation?</p>
          <div class="star-rating" id="starRating">
            <button onclick="setRating(1)" title="1 star">★</button>
            <button onclick="setRating(2)" title="2 stars">★</button>
            <button onclick="setRating(3)" title="3 stars">★</button>
            <button onclick="setRating(4)" title="4 stars">★</button>
            <button onclick="setRating(5)" title="5 stars">★</button>
          </div>
          <input type="text" id="correctTranslation" class="form-control form-control-sm mb-2"
                 placeholder="Correct translation (optional)" style="border-radius:8px; font-size:.85rem;"/>
          <button onclick="submitFeedback()" class="btn btn-brand btn-sm w-100">
            <i class="bi bi-send me-1"></i>Submit Feedback
          </button>
        </div>
      </div>

      <!-- Session Log -->
      <div class="log-card flex-grow-1">
        <div class="log-header">
          <span class="card-section-title">
            <i class="bi bi-list-ul"></i>Session Log
          </span>
          <button class="btn btn-sm btn-outline-secondary" style="font-size:.78rem; border-radius:7px;" onclick="clearLog()">
            <i class="bi bi-trash me-1"></i>Clear
          </button>
        </div>
        <div class="log-scroll" id="translationHistory">
          <div class="log-empty" id="logEmpty">
            <i class="bi bi-hand-index-thumb"></i>
            <span>Signs will appear here as they're detected</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const SESSION_ID = {{ session.pk }};
let stream = null;
let autoInterval = null;
let currentRecordId = null;
let currentRating = 0;
let logHasItems = false;

const video   = document.getElementById('video');
const canvas  = document.getElementById('canvas');
const ctx     = canvas.getContext('2d');

/* ── Camera ──────────────────────────────── */
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
      audio: false
    });
    video.srcObject = stream;
    document.getElementById('cameraIdle').style.display = 'none';
    document.getElementById('liveChip').classList.add('show');

    setStatus('active', 'Live — detecting signs');
    document.getElementById('btnStart').classList.add('d-none');
    document.getElementById('btnStop').classList.remove('d-none');
    document.getElementById('btnCapture').classList.remove('d-none');

    if (document.getElementById('autoMode').checked) startAuto();

    document.getElementById('autoMode').addEventListener('change', function() {
      this.checked ? startAuto() : stopAuto();
    });

  } catch(e) {
    alert('Camera access denied. Please allow camera access in your browser settings.\n\n' + e.message);
  }
}

function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stopAuto();
  stream = null;

  document.getElementById('cameraIdle').style.display = 'flex';
  document.getElementById('liveChip').classList.remove('show');
  setStatus('', 'Camera off');
  document.getElementById('btnStart').classList.remove('d-none');
  document.getElementById('btnStop').classList.add('d-none');
  document.getElementById('btnCapture').classList.add('d-none');

  fetch("{% url 'end_session' %}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: SESSION_ID })
  });
}

function startAuto() { autoInterval = setInterval(captureAndAnalyze, 3000); }
function stopAuto()  { clearInterval(autoInterval); autoInterval = null; }

/* ── Capture & Analyze ───────────────────── */
async function captureAndAnalyze() {
  if (!stream) return;
  setStatus('processing', 'Analyzing…');

  canvas.width  = video.videoWidth  || 640;
  canvas.height = video.videoHeight || 480;
  ctx.drawImage(video, 0, 0);
  const frame = canvas.toDataURL('image/jpeg', 0.72);
  const lang  = document.getElementById('langSelect').value;

  try {
    const resp = await fetch("{% url 'analyze_frame' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ frame, session_id: SESSION_ID, sign_language: lang })
    });
    const data = await resp.json();

    if (data.status === 'success') {
      displayResult(data);
      addToLog(data);
      setStatus('active', 'Live — detecting signs');
    } else {
      setStatus('active', 'No clear sign — keep signing');
    }
  } catch(e) {
    setStatus('active', 'Network error — retrying…');
  }
}

/* ── Display result ──────────────────────── */
function displayResult(data) {
  document.getElementById('signName').textContent        = data.detected_sign;
  document.getElementById('translationText').textContent = data.translated_text;
  document.getElementById('descriptionText').textContent = data.description || '';
  document.getElementById('confidenceValue').textContent = data.confidence_score + '%';

  const bar = document.getElementById('confidence-bar');
  bar.style.width = data.confidence_score + '%';
  bar.style.background =
    data.confidence_score >= 80 ? '#22c55e' :
    data.confidence_score >= 50 ? '#f59e0b' : '#ef4444';

  currentRecordId = data.record_id;
  document.getElementById('btnSpeak').disabled    = false;
  document.getElementById('btnFeedback').disabled = false;

  speakTranslation(data.translated_text);
}

/* ── Session log ─────────────────────────── */
function addToLog(data) {
  const hist = document.getElementById('translationHistory');
  const empty = document.getElementById('logEmpty');
  if (empty) empty.remove();

  const div = document.createElement('div');
  div.className = 'history-item';
  div.innerHTML = `
    <span class="hi-sign">${escHtml(data.detected_sign)}</span>
    <i class="bi bi-arrow-right hi-arrow"></i>
    <span class="hi-text">${escHtml(data.translated_text)}</span>
    <span class="hi-conf">${data.confidence_score}%</span>
  `;
  hist.insertBefore(div, hist.firstChild);
  logHasItems = true;
}

function clearLog() {
  const hist = document.getElementById('translationHistory');
  hist.innerHTML = `
    <div class="log-empty" id="logEmpty">
      <i class="bi bi-hand-index-thumb"></i>
      <span>Signs will appear here as they're detected</span>
    </div>`;
  logHasItems = false;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ── Speech ──────────────────────────────── */
function speakTranslation(text) {
  const t = text || document.getElementById('translationText').textContent;
  if (!t || t === 'Waiting for sign…') return;
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(t);
    utter.lang  = 'en-US';
    utter.rate  = 0.95;
    utter.pitch = 1;
    window.speechSynthesis.speak(utter);
  }
}

/* ── Feedback ────────────────────────────── */
function toggleFeedback() {
  document.getElementById('feedbackPanel').classList.toggle('d-none');
}

function setRating(n) {
  currentRating = n;
  document.querySelectorAll('#starRating button').forEach((s, i) => {
    s.style.color = i < n ? '#f59e0b' : '#d1d5db';
  });
}

async function submitFeedback() {
  if (!currentRecordId) return;
  await fetch("{% url 'submit_feedback' %}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      record_id: currentRecordId,
      rating: currentRating || 3,
      correct_translation: document.getElementById('correctTranslation').value
    })
  });
  document.getElementById('feedbackPanel').classList.add('d-none');
  document.getElementById('correctTranslation').value = '';
  currentRating = 0;
  document.querySelectorAll('#starRating button').forEach(s => s.style.color = '#d1d5db');
}

/* ── Status ──────────────────────────────── */
function setStatus(type, text) {
  document.getElementById('statusDot').className = type;
  document.getElementById('statusText').textContent = text;
}

window.addEventListener('beforeunload', () => { if (stream) stopCamera(); });
</script>
{% endblock %}